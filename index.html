<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Scanner</title>
    <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.1/xlsx.full.min.js"></script>
</head>
<body>

<h1>QR Code Scanner</h1>

<!-- Video element where the camera feed will appear -->
<div id="reader" style="width: 600px; height: 400px;"></div>

<!-- Display the extracted SRNO -->
<p><strong>Extracted SRNO:</strong> <span id="srno">None</span></p>

<!-- Buttons to scan another QR and download Excel -->
<button id="scanAnotherBtn" style="display: none;" onclick="startQRScanner()">Scan Another QR</button>
<button id="downloadExcelBtn" style="display: none;" onclick="downloadExcel()">Download Excel</button>

<script>
    let scannedSRNOs = [];  // Array to store all scanned SRNO values

    // Function to handle the scanned QR Code data
    function onScanSuccess(decodedText, decodedResult) {
        console.log("Decoded QR: ", decodedText);

        // Parse the QR code content as XML
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(decodedText, "text/xml");

        // Extract the SRNO value
        const srno = xmlDoc.getElementsByTagName("SRNO")[0].textContent;

        // Display the SRNO value on the page
        document.getElementById("srno").textContent = srno;

        // Store the SRNO in the array
        scannedSRNOs.push(srno);

        // Show the 'Scan Another QR' button and 'Download Excel' button
        document.getElementById("scanAnotherBtn").style.display = 'inline';
        document.getElementById("downloadExcelBtn").style.display = 'inline';
        
        // Stop the QR scanning temporarily
        stopQRScanner();
    }

    // Function to handle QR Code scan error
    function onScanError(errorMessage) {
        console.warn(errorMessage);
    }

    // Function to start QR scanner with camera access
    function startQRScanner() {
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            // Ensure the user has granted camera permission
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(function (stream) {
                    const html5QrCode = new Html5Qrcode("reader");

                    // Start scanning with the camera
                    html5QrCode.start(
                        { facingMode: "environment" }, // Use the rear camera
                        {
                            fps: 10, // Frames per second
                            qrbox: { width: 250, height: 250 } // Area for QR code scanning
                        },
                        onScanSuccess,
                        onScanError
                    ).catch((err) => {
                        console.error("Error starting QR scanner:", err);
                    });
                })
                .catch(function (err) {
                    alert("Camera permission is required to scan QR codes.");
                    console.error("Camera access denied:", err);
                });
        } else {
            alert("Your browser does not support camera access.");
        }
    }

    // Stop the QR Code scanner
    function stopQRScanner() {
        const html5QrCode = new Html5Qrcode("reader");
        html5QrCode.stop().then(() => {
            console.log("QR scanner stopped.");
        }).catch((err) => {
            console.error("Error stopping QR scanner:", err);
        });
    }

    // Function to download all scanned SRNOs as an Excel file
    function downloadExcel() {
        // Create a worksheet from the scanned data
        const ws = XLSX.utils.aoa_to_sheet([["SRNO"], ...scannedSRNOs.map(srno => [srno])]);

        // Create a workbook
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Scanned SRNOs");

        // Generate Excel file and trigger download
        XLSX.writeFile(wb, "scanned_srnos.xlsx");
    }

    // Start scanning on page load
    window.onload = function() {
        // Start QR scanning only when user allows camera access
        startQRScanner();
    };
</script>

</body>
</html>
